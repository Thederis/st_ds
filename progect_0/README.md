# Проект 7. Выбираем авто выгодно  
## Юнит 8. Нейронные сети  
### skillfactory_rds  
![https://img.shields.io/badge/Python-3.8.5-blue](https://img.shields.io/badge/Python-3.8.5-blue)

## Оглавление  
[1. Описание проекта](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Описание-проекта)  
[2. Какой кейс решаем?](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Какой-кейс-решаем)  
[3. Краткая информация о данных](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Краткая-информация-о-данных)  
[4. Этапы работы над проектом](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Этапы-работы-над-проектом)  
[5. Результат](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Результат)  

### Описание проекта  
Вы работаете в компании, которая занимается продажей автомобилей с пробегом в Москве. В этом модуле вам нужно построить модель классификации изображений. Классифицировать мы будем автомобили по их фотографиям  

***Чем мы будем заниматься?***  
- Построим свой классификатор изображений.
- Применим различные методы предобработки изображений
- Задействуем сразу несколько методов обучения (finetuning, transfer learning и так далее)
- Научимся использовать предобученные модели для решения своих задач
- Найдем и используем в работе State of the Art (SOTA)-модели  
:arrow_up:[к оглавлению](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Оглавление)

### Какой кейс решаем?
Вы работаете в компании, которая занимается продажей автомобилей с пробегом в Москве.  
Основная задача компании и её менеджеров — максимально быстро находить выгодные предложения (проще говоря, купить ниже рынка, а продать дороже рынка).  
В прошлом проекте вы построили модель которая предсказывает стоимость автомобиля по его характеристикам.  
Теперь перед вам предстоит построить модель классификации изображений автомобилей по их фотографиям  

**Условия соревнования:**  
[Ссылка на закрытое соревнование](https://www.kaggle.com/c/sf-dl-car-classification)  
- Данное соревнование является бессрочным и доступно для всех потоков.
- Срок выполнения соревнования устанавливаеться индивидуально в каждом потоке.
- Тестовая выборка представлена в ЛидерБорде целиком.
- Лучшие и победные решения буду проверяться на воспроизводимость и "адекватность" (чтоб не было подгонки под тестовую выборку).

**Метрика качества**
Результаты оцениваются по метрике accuracy — доля правильных ответов модели  
:arrow_up:[к оглавлению](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Оглавление)

### Краткая информация о данных
- train.csv - метки к тренировочной базе фотографий авто
- train.zip - тренировочная база фотографий авто (10 типов)
- test.zip - тестовая база фотографий авто
- sample-submission.csv - пример правильного формата submission file
  
:arrow_up:[к оглавлению](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Оглавление)

### Этапы работы над проектом  

- провел много тестов и сформировал предварительные гиперпараметры модели перед тонкой настройкой:  
    ---- тестировал:
    - модели (Xception, EfficientNetB0, EfficientNetB3)
    - аугментация: 
      - повороты от 1 до 25 градусов с шагом 2-5
      - изменение яркости от 0.1 до 2.5 с шагом 0.2-0.5
      - изменение диапозонов по ширине и высоте от 0.01 до 0.2 с шагом 0.02-0.05
      - переворачивание по горионтали и без
      - с маштабированием и без
      - разные размеры картинки и batch
      - продвинутая аугментация albumantation
    - улучшение головы (Custom Head): 
      - с Batch-нормализацией и без
      - с включенным баейсом и без
      - с встроенной регуляризацией keras - l1,l2 и без
    - callback: 
      - ModelCheckpoint
      - EarlyStopping (с разными patience)
      - использовал разные техники управления LR LearningRateScheduler (с разными функциями sheduler)
      - добавил отдельный параметр для сбора времени кадого batch, эпохи и всего обучения
    - обучение:
      - попробовал разные оптимизаторы: Adam, Adamax Nadam
      - разные вариации LR и sheduler
- создал систему для удобного хранения ВСЕХ гиперпараметров и результатов тестов
- далее применил применил тонкую настройку (fine-tuning): 
  - Этап 1: заморозил базовую модель полностью
  - Этап 2: заморозил базовую модель на половину (начиная с block5a) и снизил LR
  - Этап 3: разморозил базовую модель полностью и снизил LR  
- дообучил модель на увеличенном размере фото со снижением batch до 16
- сначала сделал сабмишен без TTA
- потом добавил TTA (Test Time Augmentation) и сделал сабмишен с TTA.
- тайминг по проекту:
  - начало - 09.12.2020
  - выполненние проекта паралельно с общим учебным процессом (примерно 160-170 часов)
  - до 13.01.21:
    -  использовал 40+36=76 часов GPU на kaggle
    -  провел около 40 экпериментов не вошедших в датасет
    -  провел около 60 экспериментов 56 из которых вошли в датасет
    -  сделал 3 сабмишена до 13 места
  - после 13.01.21:
    - использовал 15 часов GPU на kaggle для оформления решения на кагл
    - сделал 10 сабмишенов для отладки ноутбука с решением
    - паралельно улучшил результат до 7 места
  - 31.01.21 - созвон и публикация решения на кагл   
:arrow_up:[к оглавлению](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Оглавление)

### Результат:  
- score на kaggle = 0.97558 (7 место, Top 6%)
- [ноутбук на kaggle](https://www.kaggle.com/sokolovaleks/sf-dst-10-car-classification-sokolov)  
- предварительные параметры для Fine-Tuning (EfficientNetB3, 320, 32, Custom Head(128, Batch Normalization, , callback(MC_ES_LRS_T)). Детально параметры лучше посмотреть в ноутбуке.
- дообучение на увеличенном размере фото (size=520, batch=**12**) вырастило VAL_ACC на 0.52% с 0.969 до 0.9741 
- score без TTA - 0.97423
- score c TTA - 0.97558 (+0.13%)


К сожалению не хватило времени, чтобы:
- вычислить на каких картинках ошибается модель
- попытаться дополнить этот класс фото извне внешним датасетом
- дообучить модель на сложных примерах (в том числе: 
  - 7 кат. - Лада 2109, а 9 кат. - Лада 21099, которые отличаются только типом кузова сзади. Спереди эти модели выпускаются на эдентичных запчастях. Поэтому фото спереди по этим моделям не отличимы в принципе. 
  - первая фото в тесте 305108.jpg относится к кат. 2 - Lada Samara 2114 из-за наличия молдинга. Но так как фото сделано в темное время суток настроек аугментации не хватает чтобы выкрутить яркость и она классифицируется как 7 и 9 кат. Можно было бы сделать промежуточную сеть, чтобы классифицировать темные изображения и доучить на них модель или отдельно проклассифицировать, но это уже будет не Single Model.
- организовать проверку выбросов в тренировочной выборке с помощью обученной модели (я там краем глаза видел грузовик :) когда просматривал фото)  
:arrow_up:[к оглавлению](https://github.com/alex-sokolov2011/skillfactory_rds/blob/master/module_7/README.md#Оглавление)

Если информация по этому проекту покажется вам интересной или полезной, то я буду очень вам благодарен, если отметите репозиторий и профиль ⭐️⭐️⭐️-дами